# Multi-stage build for WhatsApp MCP Server
# FROM golang:1.24-alpine AS go-builder
FROM golang:1.25.4 AS go-builder

# Install build dependencies for Go
# RUN apk add --no-cache \
#     build-base \
#     sqlite-dev \
#     gcc \
#     musl-dev musl-utils
# musl-base musl-tools
RUN apt-get update && apt-get install -y  \
    sqlite3 libsklite3-dev

WORKDIR /build

# Copy go bridge source
COPY whatsapp-bridge /build/

# ENV CGO_ENABLED=0
# ENV GOOS=linux
# ENV GOARCH=amd64
# ENV CC=musl-gcc

# Build the Go application
# RUN go mod download && \
#     go build -o ./whatsapp-bridge main.go
RUN go mod download && \
    CGO_ENABLED=1 CC=musl-gcc go build -ldflags '-extldflags "-static"' -o ./whatsapp-bridge main.go

# Final stage
FROM python:3.11-slim

# Install system dependencies
RUN apt-get update && apt-get install -y \
    # For Go bridge
    ca-certificates \
    # For FFmpeg audio conversion
    ffmpeg \
    # For database
    sqlite3 \
    libsqlite3-dev \
    # For general utilities
    curl \
    git \
    # For building Python packages
    build-essential \
    gcc \
    # For running CGO-compiled Go binaries
    libc6 \
    && rm -rf /var/lib/apt/lists/*

# Install Go in the final image (needed for running whatsapp-bridge)
RUN curl -L https://go.dev/dl/go1.25.4.linux-amd64.tar.gz -o /tmp/go.tar.gz && \
    tar -C /usr/local -xzf /tmp/go.tar.gz && \
    rm /tmp/go.tar.gz

ENV PATH="/usr/local/go/bin:$PATH"

# Create app directory
WORKDIR /app

# Copy entire project
COPY . /app/

# Copy built Go binary from builder stage
COPY --from=go-builder /build/whatsapp-bridge /app/whatsapp-bridge/whatsapp-bridge

# Install Python dependencies for MCP server
WORKDIR /app/whatsapp-mcp-server
RUN pip install --no-cache-dir \
    httpx>=0.28.1 \
    "mcp[cli]>=1.6.0" \
    requests>=2.32.3

# Create directory for SQLite database storage
RUN mkdir -p /app/whatsapp-bridge/store

# Expose ports (if needed for local development)
EXPOSE 8000

# Set environment variables
ENV PYTHONUNBUFFERED=1
ENV CGO_ENABLED=1

# Copy entrypoint script
COPY entrypoint.sh /app/entrypoint.sh
RUN chmod +x /app/entrypoint.sh

# Set working directory
WORKDIR /app

ENTRYPOINT ["/app/entrypoint.sh"]
